# エージェント運用ガイド（Codex CLI）

このドキュメントは、tatsutori リポジトリで AI エージェント（Codex CLI）を安全かつ効率的に活用するための手引きです。短い依頼でも構いませんが、合意と再現性を重視します。

## 目的と原則

- 最小変更: 要求に必要な範囲のみを編集します。
- 根本解決: 表面対応より原因を修正します。
- 一貫性: 既存のコード/スタイルに合わせます。
- 安全性: 破壊的操作やシークレット露出を避けます。
- 透明性: 実行前に意図と手順を簡潔に共有します。

## 依頼の書き方（例）

- バグ修正: 「TaskListView のクラッシュを修正。再現手順: … 期待: …」
- 機能追加: 「RemindersService に X を追加。仕様: … 入出力: … UI 変更: …」
- ドキュメント: 「README にセットアップ手順 macOS/CI を追記」
- 改修の制約: 「ファイル追加のみ/既存関数外は変更禁止」など

可能なら次も含めてください:
- 目的・受け入れ条件・範囲外
- 影響範囲（UI/ビルド/テスト）
- 優先度/期日/根拠

## 作業フロー（エージェント側）

1. 事前メッセージ: これから行う操作を1–2文で共有
2. 計画（必要時）: `update_plan` に短い TODO を記録
   - スペック駆動タスクは `./.cckiro/specs/spec-driven-development/workflow.md` を参照してフェーズごとに承認を取得
3. 調査: `rg` でコード/テキスト検索、ファイルを小分けで閲覧
4. 変更: `apply_patch` でピンポイント編集（新規/更新/削除）
5. 検証: 実行/ビルド/テストの提案、必要ならユーザー承認を取得
6. 共有: 変更点・根拠・次の提案を短く報告

## サンドボックス/承認ポリシー（本プロジェクト）

- ファイル権限: workspace-write（ワークスペース内のみ書き込み可能）
- ネットワーク: restricted（外部通信は原則不可）
- 承認: on-request（重要/外部要件のある操作は承認依頼）
- 禁止操作例: 破壊的 `rm`、`git commit/push`（ユーザーが要求した場合のみ）

## コマンドと読み取り規約

- 検索: `rg` を優先使用（速い）。`rg --files` で一覧
- ファイル閲覧: 1 回 250 行以内に分割して読む
- 大きな変更前に意図を共有。細かな `cat` は逐一の前置き不要

## 変更ガイドライン

- コードスタイル: 既存と整合。不要なリネーム/再構成は避ける
- 命名: 明確で一貫した名前。日本語コメントは最小限
- 秘密情報: `Sources/Features/Settings/Secrets.swift` 等に直書きしない
- テスト: 可能なら追加/更新。ない場合は影響範囲中心に検証
- ドキュメント: 仕様・制約・使い方を最小で残す（このファイル含む）

## Swift プロジェクト補足

- 主なソース: `Sources/**`（および `tatsutory/Sources/**`）
- よく触る領域: Planner/Preview/Settings/Reminders などの各 Feature
- エラー/モデル: `Sources/Core/**`
- ビルド/テスト（ローカル開発者向け）:
  - ビルド: `swift build`
  - テスト: `swift test`

※ CI/ローカル環境に依存する操作は、エージェントは提案・差分のみ行い、実行は開発者が確認します。

## 典型タスクのパターン

- バグ修正: 再現 → 影響調査 → 最小修正 → 回帰確認
- 機能追加: 仕様確定 → API/モデル定義 → 実装 → 簡易検証 → ドキュメント
- リファクタ: 目的明示 → 小さなステップ → 動作同等性の確認

## 既知のルール（エージェント実装上）

- `git commit` は実行しない（ユーザーが明示依頼時のみ）
- ネットワーク依存のインストール等は行わない
- 大量出力を避け、必要十分な抜粋/差分のみ共有
- ファイルパスは VS Code でクリック可能な相対形式で提示

## テンプレ（依頼用）

```
目的: （何のために）
要求: （やってほしいことを箇条書き）
受け入れ条件: （結果の判定基準）
制約: （変更範囲/期限/禁止事項など）
参考: （関連ファイル/Issue/PR/設計メモ）
```

## 変更履歴

- 2025-09-12: 初版作成

---
何をどこまで自動化するかは柔軟に調整します。必要があれば、このガイド自体の更新も依頼してください。
